---
# ============================================
# Playbook Principal - Infrastructure DevOps HA
# Mega TP - Administration de systÃ¨mes rÃ©partis
# ============================================
# 
# Ce playbook dÃ©ploie l'infrastructure complÃ¨te:
# - Serveur Zabbix sur Admin
# - Cluster HA Pacemaker/Corosync sur Node01/Node02
# - Services Web (Nginx) et Fichiers (Samba) en HA
# - Active Directory sur WinSrv
# - SÃ©curisation de tous les serveurs
#
# Usage: ansible-playbook site.yml
# ============================================

- name: "Phase 0 - VÃ©rification de la connectivitÃ©"
  hosts: all
  gather_facts: no
  tasks:
    - name: Attendre que les machines soient accessibles
      wait_for_connection:
        timeout: 300
      tags: always

- name: "Phase 1 - Configuration commune des serveurs Linux"
  hosts: linux_servers
  become: yes
  roles:
    - role: common
      tags: [common, setup]

- name: "Phase 2 - DÃ©ploiement du serveur Zabbix"
  hosts: zabbix_servers
  become: yes
  roles:
    - role: zabbix-server
      tags: [zabbix, monitoring]

- name: "Phase 3 - Configuration du cluster HA"
  hosts: ha_cluster
  become: yes
  roles:
    - role: ha-cluster
      tags: [cluster, ha, pacemaker, corosync]

- name: "Phase 4 - DÃ©ploiement Nginx en HA"
  hosts: ha_cluster
  become: yes
  roles:
    - role: nginx-ha
      tags: [nginx, web, ha]

- name: "Phase 5 - DÃ©ploiement Samba en HA"
  hosts: ha_cluster
  become: yes
  roles:
    - role: samba-ha
      tags: [samba, smb, ha]

- name: "Phase 6 - Configuration des ressources du cluster"
  hosts: ha_cluster[0]
  become: yes
  tasks:
    - name: Inclure les tÃ¢ches de configuration des ressources cluster
      include_role:
        name: ha-cluster
        tasks_from: configure_resources.yml
      tags: [cluster, resources]

- name: "Phase 7 - SÃ©curisation des serveurs Linux"
  hosts: ha_cluster
  become: yes
  roles:
    - role: security-linux
      tags: [security, hardening, linux]

- name: "Phase 8 - Installation des agents Zabbix"
  hosts: zabbix_agents
  become: yes
  roles:
    - role: zabbix-agent
      tags: [zabbix, monitoring, agent]

- name: "Phase 9 - Configuration Windows Server & Active Directory"
  hosts: windows_servers
  roles:
    - role: windows-ad
      tags: [windows, ad, activedirectory]

- name: "Phase 10 - SÃ©curisation Windows Server"
  hosts: windows_servers
  roles:
    - role: windows-hardening
      tags: [windows, security, hardening]

- name: "Phase Finale - VÃ©rification de l'infrastructure"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Afficher le rÃ©sumÃ© du dÃ©ploiement
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        DÃ‰PLOIEMENT DE L'INFRASTRUCTURE TERMINÃ‰              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                              â•‘
          â•‘  ğŸ–¥ï¸  Services dÃ©ployÃ©s:                                      â•‘
          â•‘      - Zabbix Server: http://192.168.56.10/zabbix           â•‘
          â•‘      - Cluster VIP (Web): http://192.168.56.100             â•‘
          â•‘      - Samba Share: \\192.168.56.100\share                  â•‘
          â•‘      - Active Directory: lab.local                          â•‘
          â•‘                                                              â•‘
          â•‘  ğŸ“Š Credentials:                                             â•‘
          â•‘      - Zabbix: Admin / zabbix                               â•‘
          â•‘      - AD Admin: LAB\Administrator / Admin2025!             â•‘
          â•‘                                                              â•‘
          â•‘  ğŸ”§ Commandes utiles:                                        â•‘
          â•‘      - Ã‰tat cluster: sudo pcs status                        â•‘
          â•‘      - Logs cluster: sudo journalctl -u pacemaker           â•‘
          â•‘                                                              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags: always
