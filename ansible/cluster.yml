---
# ============================================
# Playbook Cluster HA - cluster.yml
# DÃ©ploiement Pacemaker, Corosync, Nginx, Samba
# ============================================

- name: "Configuration commune des nÅ“uds du cluster"
  hosts: ha_cluster
  become: yes
  roles:
    - role: common
      tags: [common, setup]

- name: "Installation et configuration du cluster HA"
  hosts: ha_cluster
  become: yes
  roles:
    - role: ha-cluster
      tags: [cluster, ha, pacemaker, corosync]

- name: "DÃ©ploiement Nginx en haute disponibilitÃ©"
  hosts: ha_cluster
  become: yes
  roles:
    - role: nginx-ha
      tags: [nginx, web, ha]

- name: "DÃ©ploiement Samba en haute disponibilitÃ©"
  hosts: ha_cluster
  become: yes
  roles:
    - role: samba-ha
      tags: [samba, smb, ha]

- name: "Configuration des ressources du cluster"
  hosts: ha_cluster[0]
  become: yes
  tasks:
    - name: Configurer les ressources Pacemaker
      include_role:
        name: ha-cluster
        tasks_from: configure_resources.yml
      tags: [cluster, resources]

- name: "VÃ©rification finale du cluster"
  hosts: ha_cluster[0]
  become: yes
  tasks:
    - name: Attendre que le cluster soit stable
      command: pcs status
      register: cluster_status
      until: cluster_status.rc == 0
      retries: 10
      delay: 10

    - name: Afficher l'Ã©tat du cluster
      debug:
        var: cluster_status.stdout_lines

    - name: Tester l'accÃ¨s via la VIP
      uri:
        url: "http://{{ vip_address }}"
        status_code: 200
      register: vip_test
      ignore_errors: yes

    - name: RÃ©sumÃ© du cluster
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CLUSTER HAUTE DISPONIBILITÃ‰ OPÃ‰RATIONNEL
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“ VIP: {{ vip_address }}
          ğŸŒ Web: http://{{ vip_address }}
          ğŸ“ Samba: \\{{ vip_address }}\share
          
          ğŸ“¦ Ressources:
             - cluster_vip (IPaddr2)
             - nginx_service (Nginx)
             - samba_service (SMB)
          
          âœ… Test VIP: {{ 'OK' if vip_test.status == 200 else 'ECHEC' }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
