---
# ============================================
# Role: zabbix-server
# Installation et configuration de Zabbix Server sur Ubuntu
# Mission 4 du TP
# ============================================

- name: Installer les d√©pendances
  apt:
    name:
      - apache2
      - mysql-server
      - mysql-client
      - php
      - php-mysql
      - php-gd
      - php-bcmath
      - php-mbstring
      - php-xml
      - php-ldap
      - libapache2-mod-php
      - python3-pymysql
      - wget
      - gnupg2
    state: present
    update_cache: yes

- name: T√©l√©charger le d√©p√¥t Zabbix
  get_url:
    url: "https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.0+ubuntu22.04_all.deb"
    dest: /tmp/zabbix-release.deb
    mode: '0644'

- name: Installer le d√©p√¥t Zabbix
  apt:
    deb: /tmp/zabbix-release.deb
    state: present

- name: Mettre √† jour le cache APT apr√®s ajout du d√©p√¥t
  apt:
    update_cache: yes

- name: Installer Zabbix Server et composants
  apt:
    name:
      - zabbix-server-mysql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-sql-scripts
      - zabbix-agent
    state: present

- name: D√©marrer et activer MySQL
  service:
    name: mysql
    state: started
    enabled: yes

- name: Cr√©er la base de donn√©es Zabbix
  mysql_db:
    name: zabbix
    encoding: utf8mb4
    collation: utf8mb4_bin
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Cr√©er l'utilisateur Zabbix dans MySQL
  mysql_user:
    name: zabbix
    password: "ZabbixDBP@ss2025"
    priv: 'zabbix.*:ALL'
    host: localhost
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Configurer les variables MySQL pour le sch√©ma
  mysql_variables:
    variable: log_bin_trust_function_creators
    value: 1
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: V√©rifier si le sch√©ma Zabbix est d√©j√† import√©
  mysql_query:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    login_db: zabbix
    query: "SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = 'zabbix'"
  register: zabbix_tables
  ignore_errors: yes

- name: Importer le sch√©ma Zabbix
  shell: |
    zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql -u zabbix -p'ZabbixDBP@ss2025' zabbix
  when: zabbix_tables.query_result[0][0].count | int < 10
  ignore_errors: yes

- name: R√©initialiser la variable MySQL
  mysql_variables:
    variable: log_bin_trust_function_creators
    value: 0
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: Configurer Zabbix Server
  lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^# DBPassword=', line: 'DBPassword=ZabbixDBP@ss2025' }
    - { regexp: '^DBPassword=', line: 'DBPassword=ZabbixDBP@ss2025' }
    - { regexp: '^# DBHost=', line: 'DBHost=localhost' }
  notify: restart zabbix-server

- name: Configurer PHP pour Zabbix
  lineinfile:
    path: /etc/php/8.1/apache2/php.ini
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^;?date.timezone', line: 'date.timezone = Europe/Paris' }
    - { regexp: '^;?max_execution_time', line: 'max_execution_time = 300' }
    - { regexp: '^;?memory_limit', line: 'memory_limit = 128M' }
    - { regexp: '^;?post_max_size', line: 'post_max_size = 16M' }
    - { regexp: '^;?upload_max_filesize', line: 'upload_max_filesize = 2M' }
    - { regexp: '^;?max_input_time', line: 'max_input_time = 300' }
  notify: restart apache2

- name: Cr√©er le fichier de configuration web Zabbix
  template:
    src: zabbix.conf.php.j2
    dest: /etc/zabbix/web/zabbix.conf.php
    owner: www-data
    group: www-data
    mode: '0644'

- name: Activer les modules Apache n√©cessaires
  apache2_module:
    name: "{{ item }}"
    state: present
  loop:
    - rewrite
    - php8.1
  notify: restart apache2

- name: Ouvrir le port HTTP dans UFW
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "80"
    - "10050"
    - "10051"
  ignore_errors: yes

- name: Activer et d√©marrer Zabbix Server
  service:
    name: zabbix-server
    state: started
    enabled: yes

- name: Activer et d√©marrer Zabbix Agent
  service:
    name: zabbix-agent
    state: started
    enabled: yes

- name: Red√©marrer Apache
  service:
    name: apache2
    state: restarted
    enabled: yes

- name: Attendre que Zabbix soit accessible
  uri:
    url: "http://localhost/zabbix"
    status_code: 200
  register: zabbix_check
  until: zabbix_check.status == 200
  retries: 12
  delay: 10
  ignore_errors: yes

- name: Afficher les informations de connexion Zabbix
  debug:
    msg: |
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      ZABBIX SERVER INSTALL√â AVEC SUCC√àS
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      
      üìä Acc√®s Web: http://{{ ansible_host }}/zabbix
      
      üîë Identifiants par d√©faut:
         - Utilisateur: Admin
         - Mot de passe: zabbix
      
      ‚ö†Ô∏è  IMPORTANT: Changez le mot de passe par d√©faut !
      
      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
