---
# ============================================
# Role: windows-ad
# Installation et configuration d'Active Directory
# Mission 3 du TP
# ============================================

- name: S'assurer que le serveur a une IP statique configurÃ©e
  win_shell: |
    $adapter = Get-NetAdapter | Where-Object {$_.Status -eq 'Up'} | Select-Object -First 1
    $currentIP = (Get-NetIPAddress -InterfaceIndex $adapter.ifIndex -AddressFamily IPv4).IPAddress
    Write-Output "Current IP: $currentIP"
  register: current_ip

- name: Afficher l'IP actuelle
  debug:
    var: current_ip.stdout

- name: Installer les fonctionnalitÃ©s AD DS
  win_feature:
    name:
      - AD-Domain-Services
      - RSAT-AD-Tools
      - RSAT-ADDS
      - RSAT-AD-PowerShell
      - DNS
      - RSAT-DNS-Server
    state: present
    include_management_tools: yes
  register: ad_feature

- name: RedÃ©marrer si nÃ©cessaire aprÃ¨s installation des features
  win_reboot:
    reboot_timeout: 600
    post_reboot_delay: 30
  when: ad_feature.reboot_required

- name: VÃ©rifier si le domaine existe dÃ©jÃ 
  win_shell: |
    try {
      $domain = Get-ADDomain -ErrorAction Stop
      Write-Output "DOMAIN_EXISTS"
    } catch {
      Write-Output "NO_DOMAIN"
    }
  register: domain_check
  ignore_errors: yes

- name: Promouvoir le serveur en contrÃ´leur de domaine
  win_domain:
    dns_domain_name: "{{ ad_domain_name }}"
    domain_netbios_name: "{{ ad_domain_netbios }}"
    safe_mode_password: "{{ ad_safe_mode_password }}"
    database_path: C:\Windows\NTDS
    log_path: C:\Windows\NTDS
    sysvol_path: C:\Windows\SYSVOL
  register: domain_promotion
  when: "'NO_DOMAIN' in domain_check.stdout"

- name: RedÃ©marrer aprÃ¨s promotion du contrÃ´leur de domaine
  win_reboot:
    reboot_timeout: 900
    post_reboot_delay: 120
    msg: "RedÃ©marrage aprÃ¨s promotion AD"
  when: domain_promotion.changed | default(false)

- name: Attendre que les services AD soient prÃªts
  win_shell: |
    $maxRetries = 30
    $retryCount = 0
    while ($retryCount -lt $maxRetries) {
      try {
        Get-ADDomain -ErrorAction Stop | Out-Null
        Write-Output "AD_READY"
        break
      } catch {
        $retryCount++
        Start-Sleep -Seconds 10
      }
    }
    if ($retryCount -eq $maxRetries) {
      Write-Output "AD_NOT_READY"
    }
  register: ad_ready
  until: "'AD_READY' in ad_ready.stdout"
  retries: 10
  delay: 30

- name: CrÃ©er l'unitÃ© organisationnelle pour les utilisateurs
  win_shell: |
    Import-Module ActiveDirectory
    $ouPath = "OU=Lab Users,DC={{ ad_domain_name.split('.')[0] }},DC={{ ad_domain_name.split('.')[1] }}"
    if (-not (Get-ADOrganizationalUnit -Filter "DistinguishedName -eq '$ouPath'" -ErrorAction SilentlyContinue)) {
      New-ADOrganizationalUnit -Name "Lab Users" -Path "DC={{ ad_domain_name.split('.')[0] }},DC={{ ad_domain_name.split('.')[1] }}" -ProtectedFromAccidentalDeletion $false
      Write-Output "OU_CREATED"
    } else {
      Write-Output "OU_EXISTS"
    }
  register: ou_creation

- name: CrÃ©er l'unitÃ© organisationnelle pour les ordinateurs
  win_shell: |
    Import-Module ActiveDirectory
    $ouPath = "OU=Lab Computers,DC={{ ad_domain_name.split('.')[0] }},DC={{ ad_domain_name.split('.')[1] }}"
    if (-not (Get-ADOrganizationalUnit -Filter "DistinguishedName -eq '$ouPath'" -ErrorAction SilentlyContinue)) {
      New-ADOrganizationalUnit -Name "Lab Computers" -Path "DC={{ ad_domain_name.split('.')[0] }},DC={{ ad_domain_name.split('.')[1] }}" -ProtectedFromAccidentalDeletion $false
      Write-Output "OU_CREATED"
    } else {
      Write-Output "OU_EXISTS"
    }

- name: CrÃ©er un utilisateur de test
  win_shell: |
    Import-Module ActiveDirectory
    $userPrincipal = "testuser@{{ ad_domain_name }}"
    if (-not (Get-ADUser -Filter "UserPrincipalName -eq '$userPrincipal'" -ErrorAction SilentlyContinue)) {
      $password = ConvertTo-SecureString "Test2025!" -AsPlainText -Force
      New-ADUser -Name "Test User" `
                 -SamAccountName "testuser" `
                 -UserPrincipalName $userPrincipal `
                 -GivenName "Test" `
                 -Surname "User" `
                 -DisplayName "Test User" `
                 -Path "OU=Lab Users,DC={{ ad_domain_name.split('.')[0] }},DC={{ ad_domain_name.split('.')[1] }}" `
                 -AccountPassword $password `
                 -Enabled $true `
                 -PasswordNeverExpires $true
      Write-Output "USER_CREATED"
    } else {
      Write-Output "USER_EXISTS"
    }

- name: Configurer les zones DNS inversÃ©es
  win_shell: |
    Import-Module DnsServer
    $reverseZone = "56.168.192.in-addr.arpa"
    if (-not (Get-DnsServerZone -Name $reverseZone -ErrorAction SilentlyContinue)) {
      Add-DnsServerPrimaryZone -NetworkID "192.168.56.0/24" -ReplicationScope "Domain"
      Write-Output "REVERSE_ZONE_CREATED"
    } else {
      Write-Output "REVERSE_ZONE_EXISTS"
    }
  ignore_errors: yes

- name: Ajouter les enregistrements DNS pour les nÅ“uds du cluster
  win_shell: |
    Import-Module DnsServer
    $records = @{
      "admin" = "192.168.56.10"
      "node01" = "192.168.56.11"
      "node02" = "192.168.56.12"
      "cluster-vip" = "192.168.56.100"
    }
    foreach ($name in $records.Keys) {
      $existing = Get-DnsServerResourceRecord -ZoneName "{{ ad_domain_name }}" -Name $name -ErrorAction SilentlyContinue
      if (-not $existing) {
        Add-DnsServerResourceRecordA -Name $name -ZoneName "{{ ad_domain_name }}" -IPv4Address $records[$name]
        Write-Output "Created: $name"
      }
    }

- name: Afficher le rÃ©sumÃ© de l'installation AD
  debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ACTIVE DIRECTORY CONFIGURÃ‰ AVEC SUCCÃˆS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ¢ Domaine: {{ ad_domain_name }}
      ğŸ–¥ï¸ NetBIOS: {{ ad_domain_netbios }}
      ğŸ“ ContrÃ´leur: {{ inventory_hostname }}
      
      ğŸ‘¤ Utilisateur de test:
         - Login: {{ ad_domain_netbios }}\testuser
         - Mot de passe: Test2025!
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
